#
# this is run from a simple shell script that copies the local ./setup
# directory to the selected directory on the target SD card
# then runs this script
# for trixie and bookworm
#
##############################################################################

rootdir=$1	# this is the LOCAL mountpoint for the SD card
topdir=$2	# this is the target directory on the SD card
if [ "$3" ] ; then
	# optional ssh key - developer access
	local_ssh_key=$3	
else
	local_ssh_key=
fi

[ -d "$rootdir" ] || { echo "SD card root directory not set" ; exit 1 ; }

# scripts in $topdir subdirectories will set their location
# create a config file for systemd/cust-net and networkmanger/netmon
config_file=$rootdir$topdir/local_config

# change the hotspot name and hotspot password as desired.
# please don't use spaces in the hotspot name or password
hotspot_name="Hot Spot"
hotspot_password="HotSpot1" # must be >= 8 characters

# optional ####################################################################
desired_timezone="Africa/Johannesburg"
desired_wifi_country="ZA"
##############################################################################

##############################################################################
# Changes from here onwards at your own risk
##############################################################################

echo "# generated by local_setup during sd card creation" > $config_file
echo "hotspot_name=\"$hotspot_name\"" >> $config_file
echo "hotspot_password=\"$hotspot_password\"" >> $config_file

# optional ####################################################################

[ "$desired_wifi_country" ] && echo "desired_wifi_country=$desired_wifi_country" >> $config_file
[ "$desired_timezone" ] && echo "desired_timezone=$desired_timezone" >> $config_file

if [ "$local_ssh_key" ] ; then
	# echo "enable_ssh=true" >> $config_file
	# enable ssh on the client card
	mkdir $rootdir/home/pi/.ssh
	chmod 700 $rootdir/home/pi/.ssh
	cp $local_ssh_key $rootdir/home/pi/.ssh/authorized_keys
	chmod 600 $rootdir/home/pi/.ssh/authorized_keys
	# pi is user 1000, group 1000
	chown -R 1000:1000 $rootdir/home/pi/.ssh
	# start ssh server at boot
	cd $rootdir/etc/systemd/system/multi-user.target.wants
	# link targets only matter when they are evaluated
	ln -s /lib/systemd/system/ssh.service ./ssh.service
	# give user pi a password
	# this password (raspi) from a successful installation 
	pw='$y$j9T$ABaw72hYHcI9kKU5dzbrw/$xwJSY0ru0qn7bRj9D3ydpHIO/dMzyiPwj19F1Yk3Mn1'
	sed -i 's|pi:!:|'pi:"${pw}":'|' $rootdir/etc/shadow
fi

# timezone
if [ "$desired_timezone" ] ; then
	cd $rootdir/etc
	ln -fs /usr/share/zoneinfo/$desired_timezone ./localtime
fi

###############################################################################

# what's the os version on the card
os_name=$(grep -w "VERSION_CODENAME" $rootdir/etc/os-release | cut -d= -f2)

# enable the Systemd network customization job
cd $rootdir/etc/systemd/system/multi-user.target.wants
ln -s $topdir/systemd/cust-net.service ./cust-net.service
cd $rootdir/etc/systemd/system
ln -s $topdir/systemd/cust-net.service ./cust-net.service

# enable the network monitor
# This is a job that restarts a network connection if a configured ssid comes back online
# pre trixie, runs from /NetworkManager/dispatcher.d because it's more efficient to
# run on demand rather than every 2 mins (but does it really matter?)
# for trixie, it's a cron job because systemd keeps stopping dispatcher.service
if [ "$os_name" == "trixie" ] ; then
	sed -s "s|_TARGET_|$topdir|g" $rootdir$topdir/networkmanager/netmon.template > $rootdir$topdir/crontabs/netmon
	# don't add multiple lines to crontab if this script is re-run
	grep -w netmon $rootdir/var/spool/cron/crontabs/root >/dev/null || cat < $rootdir$topdir/crontabs/netmon >> $rootdir/var/spool/cron/crontabs/root
else
	cd $rootdir/etc/NetworkManager/dispatcher.d
	ln -s $topdir/networkmanager/netmon ./netmon
fi

# enable the killswitch cron job
# change the _TARGET_ in crontabs/root
sed -s "s|_TARGET_|$topdir|g" $rootdir$topdir/crontabs/root.template > $rootdir$topdir/crontabs/killswitch
# don't add multiple lines to crontab if this script is re-run
grep -w killswitch $rootdir/var/spool/cron/crontabs/root >/dev/null || cat < $rootdir$topdir/crontabs/killswitch >> $rootdir/var/spool/cron/crontabs/root

# and fix root's crontab permissions
chmod 600 $rootdir/var/spool/cron/crontabs/root

# These services require interactive access which hangs the boot
# They _may_ be handled by sdm, but I haven't looked
# but given that we are headless, they probably aren't required

# keyboard config
unlink $rootdir/etc/systemd/system/sysinit.target.wants/keyboard-setup.service
unlink $rootdir/etc/systemd/system/multi-user.target.wants/console-setup.service

# user config
# $rootdir/etc/systemd/system/multi-user.target.wants/userconfig.service
# which is a symlink to /lib/systemd/system/userconfig.service
unlink $rootdir/etc/systemd/system/multi-user.target.wants/userconfig.service

# and turn off cloud-init for trixie - because we are nowhere near a cloud
[ "$os_name" == "trixie" ] && touch $rootdir/etc/cloud/cloud-init.disabled

